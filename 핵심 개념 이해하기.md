# 핵심 개념 이해하기

## 자바스크립트 런타임

* 노드는 자바스크립트 런타입이다.
  * 런타임: 특정 언어로 만든 프로그램들을 실행할 수 있는 환경
* 노드는 V8과 더불어 libuv라는 라이브러리 사용한다.
* libuv 라이브러리는 이벤트 기반, 논블로킹 I/O 모델을 구현하고 있다.



## 이벤트 기반 (Event-Driven)

* 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식이다.
* 이벤트에는 클릭이나 네트워크 요청 등이 있다.
* 이벤트 기반 시스템에서는 특정 이벤트가 발생할 때 무엇을 할지 미리 등록해두어야 한다.
  * 이것을 이벤트 리스너에 콜백 함수를 등록한다고 표현한다.
* 노드도 이벤트 기반 방식으로 동작하므로 이벤트가 발생하면 이벤트 리스너에 등록해둔 콜백 함수를 호출한다.
* 발생한 이벤트가 없거나 발생했던 이벤트를 다 처리하면 노드는 다음 이벤트가 발생할 때 까지 기다린다.

### 이벤트 루프

* 여러 이벤트가 동시에 발생했을 때 어떤 순서로 콜백 함수를 호출할지를 이벤트 루프가 판단한다.

~~~javascript
//예제 코드
function first() {
  second();
  console.log('첫 번째');
}
function second() {
  third();
  console.log('두 번째');
}
function third() {
  console.log('세 번째');
}

/*
세 번째
두 번째 
첫 번째
*/
~~~

* first 함수가 제일 먼저 호출되고, 그 안의 second 함수가 호출된 뒤, 마지막으로 third 함수가 호출된다.
* 실행은 호출 순서와 반대로 완료된다.
* 자바스크립트는 실행 시 기본적으로 전역 컨텍스트 안에서 돌아간다.
  * 컨텍스트: 함수가 호출되었을 때 생성되는 환경
* 함수의 실행이 완료되면 호출 스택에서 지워진다.

~~~javascript
//3초 뒤에 run 함수를 실행하는 예제
function run() {
    console.log('3초 후 실행');
}
console.log('start');
setTimeout(run, 3000);
console.log('finish');

/*
start
finish
3초 후 실행
*/
~~~

* 이벤트 루프
  * 이벤트 발생 시 호출할 콜백 함수들을 관리하고, 호출된 콜백 함수의 실행 순서를 결정하는 역할
  * 노드가 종료될 때 까지 이벤트 처리를 위한 작업을 반복하므로 루프라고 불림
* 태스크 큐
  * 이벤트 발생 후 호출되어야 할 콜백 함수들이 기다리는 공간
  * 콜백들이 이벤트 루프가 정한 순서대로 줄을 서 있으므로 콜백 큐라고도 부른다.
* 백그라운드
  * 타이머나 I/O 작업 콜백 또는 이벤트 리스너들이 대기하는 곳
* 전역 컨텍스트인 main 함수가 호출 스택에 들어간다. 그 뒤 setTimeout이 호출 스택에 들어간다.
* 호출 스택에 들어간 순서와 반대로 실행되므로 setTimeout이 먼저 실행된다.
* setTimeout이 실행되면 타이머와 함께 run 콜백을 백그라운드로 보내고 호출 스택에서 빠진다.
* 그 다음으로 main 함수가 호출 스택에서 빠진다.
* 백그라운드에서는 3초를 센 후 run 함수를 태스크 큐로 보낸다.

### 논블로킹 I/O

* 논블로킹 방식
  * 오래 걸리는 함수를 백그라운드로 보내서 다음 코드가 먼저 실행되게 하고, 그 함수가 다시 태스크 큐를 거쳐 호출 스택으로 올라오기를 기다리는 방식
  * 이전 작업이 완료될 때까지 멈추지 않고 다음 작업을 수행함을 뜻한다.
* 싱글 스레드라는 한계 때문에 자바스크립트의 모든 코드가 논블로킹 방식으로 시간적 이득을 볼 수 있는 것은 아니다.
* 노드 프로세스 외의 다른 컴퓨팅 자원을 사용할 수 있는 I/O 작업이 주로 시간적 이득을 많이 본다.

### 싱글 스레드

* 노드는 싱글 스레드이므로 주어진 작업을 혼자서 처리해야 한다.
* 자바스크립트와 노드에서 논블로킹이 중요한 이유는 싱글 스레드이기 때문이다.
* 한 번에 한 가지 일밖에 처리하지 못하므로 어떠한 작업에서 블로킹이 발생하면 다음 일을 처리하지 못한다.
* 노드도 싱글 스레드 여러 개를 이용한 멀티 스레딩, 엄밀히 말하면 멀티 프로세싱이 가능하다
  * 프로세스: 운영체제에서 할당하는 작업의 단위. 프로세스 간에는 메모리 등의 자원을 공유하지 않는다.
  * 스레드: 프로세스 내에서 실행되는 흐름의 단위. 하나의 프로세스는 여러 개의 스레드를 가질 수 있다. 스레드들은 부모 프로세스의 자원을 공유한다(같은 메모리에 접근 가능).
* 노드는 스레드를 늘리는 대신, 프로세스 자체를 복사해 여러 작업을 동시에 처리하는 멀티 프로세싱 방식을 택했다.
* 자바스크립트 언어 자체가 싱글 스레드 특성을 띄고 있기 때문이다.